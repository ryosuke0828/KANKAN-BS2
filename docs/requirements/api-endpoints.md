# APIエンドポイント要件定義書

## 1. 概要
本ドキュメントは、KANKAN-BS2バックエンドアプリケーションにおけるAPIエンドポイントの要件を定義するものです。主に、支払い計算およびDM送信に関連するユースケースに対応するエンドポイントについて記述します。

## 2. 既存エンドポイント
### 2.1. Slackリアクションからのメンバー収集
- **エンドポイント:** `POST /api/v1/members/collect-from-slack`
- **概要:** Slackの特定メッセージに対するリアクションから、関連するラボメンバーの情報を収集します。
- **入力:**
    - `userId`: ユーザーID (string)
    - `messageTimestamp`: Slackメッセージのタイムスタンプ (string)
- **出力:**
    - `LabMember`オブジェクトの配列
- **備考:** このエンドポイントは既に実装済みですが、デバッグと動作確認が必要です。

## 3. 新規エンドポイント

### 3.1. 支払い計算エンドポイント

- **ユースケース:** `CalculatePayment`
- **目的:** 複数のメンバーに対する支払い金額を計算します。
- **エンドポイント案:** `POST /api/v1/payments/calculate`
- **入力 (リクエストボディ):**
    - `userId`: 支払い計算を行うユーザーのID (string, 必須)
    - `totalAmount`: 支払い総額 (number, 必須)
    - `payers`: 支払い対象となるメンバーのリスト (配列, 必須)
        - 各`payer`オブジェクトの構成:
            - `memberId`: メンバーID (string, 必須)
            - `attribute`: メンバーの属性 (string, 例: "regular", "guest", 必須)
            - `weight`: 支払いにおける重み (number, 例: 1, 0.5, 必須)
- **出力 (レスポンスボディ):**
    - 計算された各メンバーの支払い金額リスト (配列)
        - 各オブジェクトの構成:
            - `memberId`: メンバーID (string)
            - `amount`: 計算された支払い金額 (number)
- **確認事項:**
    - `payers`の`attribute`はどのような値を取り得ますか？ (例: "regular", "guest" 以外にありますか？)
        - **回答:** 現在の設定値のままで問題ありません。
    - `payers`の`weight`はどのようなルールで設定されますか？ (例: 属性によって固定値ですか？ユーザーが自由に設定できますか？)
        - **回答:** frontendで指定された値がkv形式のjsonで来るようなイメージです。
    - 支払い計算のロジック（`PaymentCalculator`）は、端数処理（例: 切り上げ、切り捨て、四捨五入）についてどのように扱いますか？現在の実装では最初のメンバーに端数を加算していますが、これで問題ないですか？
        - **回答:** 全体の金額を切り上げて同じattributeで同じ金額となるようにしてください。また、支払い金額は10円単位で不足する場合は切り上げるようにしてください。

### 3.2. 支払いリクエストDM送信エンドポイント

- **ユースケース:** `SendPaymentRequestDm`
- **目的:** 計算された支払い金額に基づいて、各メンバーにSlack DMで支払いリクエストを送信します。
- **エンドポイント案:** `POST /api/v1/payments/send-dm`
- **入力 (リクエストボディ):**
    - `userId`: DM送信を行うユーザーのID (string, 必須)
    - `paymentRequests`: 送信する支払いリクエストのリスト (配列, 必須)
        - 各`paymentRequest`オブジェクトの構成:
            - `memberId`: 支払いリクエストを送るメンバーのID (string, 必須)
            - `amount`: 支払い金額 (number, 必須)
    - `paymentUrl`: 支払いを行うためのURL (string, 必須)
- **出力 (レスポンスボディ):**
    - 成功時は空のレスポンス (HTTP 204 No Content または 200 OK)
    - 失敗時はエラー情報
- **確認事項:**
    - DMのメッセージ内容は、現在の「`${amount}円を支払ってください。
支払いリンク: ${paymentUrl}`」で問題ないですか？追加で含めるべき情報（例: 支払い期限、イベント名など）はありますか？
        - **回答:** 現在の愛払い金額とURLのみで大丈夫です。
    - DM送信の成功/失敗はどのようにユーザーにフィードバックしますか？（例: 個別のDM送信結果を返す、全体としての成功/失敗のみを返す）
        - **回答:** 成功か失敗かをフロントエンドに返すとともに、失敗の場合はlogに残すようにしましょう。
    - `paymentUrl`はどのような形式で提供されますか？（例: 固定URL、動的に生成されるURL）
        - **回答:** フロントエンドから入力された値をそのまま送信する形式で問題ありません。

### 3.3. LabメンバーCRUDエンドポイント

- **ユースケース:** `CreateLabMember`, `GetLabMember`, `UpdateLabMember`, `DeleteLabMember`
- **目的:** ラボメンバー情報の作成、取得、更新、削除を行います。
- **エンドポイント案:**
    - **作成:** `POST /api/v1/lab-members`
    - **取得:** `GET /api/v1/lab-members/:id`
    - **更新:** `PUT /api/v1/lab-members/:id`
    - **削除:** `DELETE /api/v1/lab-members/:id`
- **入力 (リクエストボディ):**
    - **作成:**
        - `name`: メンバー名 (string, 必須)
        - `attribute`: メンバーの属性 (string, 例: "B3", "M1", "D", "P", "Others", 必須)
        - `slackDmId`: Slack DM ID (string, 必須)
        - `userId`: メンバーを管理するユーザーのID (string, 必須)
    - **取得:** (パスパラメータ `:id` のみ)
    - **更新:**
        - `id`: メンバーID (string, パスパラメータ `:id` と一致, 必須)
        - `name`: メンバー名 (string, 任意)
        - `attribute`: メンバーの属性 (string, 任意)
        - `slackDmId`: Slack DM ID (string, 任意)
        - `userId`: メンバーを管理するユーザーのID (string, 任意)
    - **削除:** (パスパラメータ `:id` のみ)
- **出力 (レスポンスボディ):**
    - **作成:** 作成された`LabMember`オブジェクト
    - **取得:** 取得された`LabMember`オブジェクト
    - **更新:** 更新された`LabMember`オブジェクト
    - **削除:** 成功時は空のレスポンス (HTTP 204 No Content)
- **確認事項:**
    - `attribute`の取り得る値は「B3, B4, M1, M2, D, P, Others」で合っていますか？
    - `LabMember`の作成時、`userId`はどのユーザーのIDを使用しますか？（例: リクエストを行ったユーザーのID、またはリクエストボディで指定されたID）

### 3.4. Labメンバー一括更新 (進級) エンドポイント

- **ユースケース:** `BulkUpdateLabMembersAttribute` (新規作成予定)
- **目的:** メンバーの属性を一括で進級させます。
- **エンドポイント案:** `POST /api/v1/lab-members/bulk-update-attribute`
- **入力 (リクエストボディ):**
    - `userId`: 一括更新を行うユーザーのID (string, 必須)
    - `targetAttribute`: 更新対象とする現在の属性 (string, 例: "B3", "M1", 必須)
    - `newAttribute`: 更新後の新しい属性 (string, 例: "B4", "M2", 必須)
- **処理ロジック:**
    - `targetAttribute`のメンバーを`newAttribute`に進級させます。
    - **進級ルール:** B3 → B4 → M1 → M2 → D
    - **制約:** D、P、Others の属性を持つメンバーは変更しません。
    - `targetAttribute`と`newAttribute`が上記の進級ルールに沿っているかバリデーションを行います。
- **出力 (レスポンスボディ):**
    - 成功時は更新された`LabMember`オブジェクトの配列、または更新件数などのサマリー
    - 失敗時はエラー情報
- **確認事項:**
    - 進級ルール「B3 → B4 → M1 → M2 → D」は、この順序でしか進級できないという意味で合っていますか？（例: B3からM1への直接進級は不可）
    - `targetAttribute`と`newAttribute`の組み合わせとして、どのようなものが許容されますか？（例: B3 -> B4 のみ、M1 -> M2 のみ、など）
    - 進級処理の対象となるメンバーは、`userId`に紐づくメンバーのみですか？
    - 更新件数などのサマリーで十分ですか？それとも更新されたメンバーの全情報が必要ですか？

## 4. エラーハンドリング
- 各エンドポイントで発生しうるエラー（例: 認証エラー、バリデーションエラー、外部サービス連携エラー）について、どのようなHTTPステータスコードとレスポンスボディを返すか定義する必要があります。
    - **回答:** 基本的に世界で推奨されているものに準拠してください。

## 5. 認証・認可
- 各エンドポイントへのアクセスはどのように認証・認可されますか？（例: APIキー、OAuthトークン、AWS IAMなど）
    - **回答:** 現時点ではログイン可能なユーザーはユーザー管理のエンドポイント以外にはアクセス可能としてください。ログイン機能は後ほど実装する必要があります。開発者がadmin userとしてユーザー管理の権限を持つ予定なので必要に応じてドメインやデータベースにisAdminなどのフラグを追加するようにしてください。
